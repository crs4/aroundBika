- name: install bika.client and dependency
  become: yes
  become_user: "{{ BIKA_USER }}"
  pip: name={{ item }} extra_args='--user' editable=false
  with_items:
    - paste
    - python-daemon
    - lockfile
    - bottle
    - git+https://github.com/ratzeni/bika.client.git

- name: install aroundBika bundle
  become: yes
  become_user: "{{ BIKA_USER }}"
  git: repo={{ item.repo }} dest={{ item.dest }}
  with_items:
    - { repo: 'https://github.com/ratzeni/bika.penelope.git', dest: "/home/{{ BIKA_USER }}/bika.penelope" }
    - { repo: 'https://github.com/ratzeni/bika.webservice.git', dest: "/home/{{ BIKA_USER }}/bika.webservice" }

- name: set penelope services mode
  file: path=/home/{{ BIKA_USER }}/bika.webservice/{{ item }} mode=0755
  with_items:
    - penelope_read_service.sh
    - penelope_write_service.sh

- name: rename init.module.js.sample
  command: mv /home/{{ BIKA_USER }}/bika.penelope/app/init.module.js.sample /home/{{ BIKA_USER }}/bika.penelope/app/init.module.js

- name: replace vars into bika.penelope config script
  replace: dest="/home/{{ BIKA_USER }}/bika.penelope/app/init.module.js" regexp="{{ item.regexp }}" replace="{{ item.repl }}"
  with_items:
    - { regexp: "DUMMY_READ_REST_URL", repl: "http://localhost:8088" }
    - { regexp: "DUMMY_WRITE_REST_URL", repl: "http://localhost:8086" }
    - { regexp: "DUMMY_BIKA_HOST", repl: "http://bikaplone:8080/Plone" }
    - { regexp: "DUMMY_IRODS_RESOURCE", repl: "demoResc" }
    - { regexp: "DUMMY_IRODS_SAMPLESHEET_COLLECTION", repl: "/tempZone/home/iuser" }
    - { regexp: "DUMMY_SSH_HOST", repl: "" }
    - { regexp: "DUMMY_SSH_USER", repl: "" }
    - { regexp: "DUMMY_TMP_FOLDER", repl: "/tmp" }
    - { regexp: "DUMMY_RUN_FOLDERS", repl: "" }
    - { regexp: "DUMMY_RUN_INFO_FILE", repl: "RunInfo.xml" }
    - { regexp: "DUMMY_RUN_PARAMTERS_FILE", repl: "runParameters.xml" }


- name: rename init.cfg.sample
  command: mv /home/{{ BIKA_USER }}/bika.webservice/init.cfg.sample /home/{{ BIKA_USER }}/bika.webservice/init.cfg

- name: create bika.webservice dirs
  become: yes
  become_user: "{{ BIKA_USER }}"
  file: path={{ item }} state=directory mode=0755
  with_items:
    - /home/{{ BIKA_USER }}/var/run
    - /home/{{ BIKA_USER }}/var/log

- name: replace vars into bika.webservice config script
  replace: dest="/home/{{ BIKA_USER }}/bika.webservice/init.cfg" regexp="{{ item.regexp }}" replace="{{ item.repl }}"
  with_items:
    - { regexp: "DUMMY_SERVICE_DIR", repl: "$HOME/bika.webservice" }
    - { regexp: "DUMMY_PID_FILE_READ", repl: "$HOME/var/run/bika_service.read.pid" }
    - { regexp: "DUMMY_PID_FILE_WRITE", repl: "$HOME/var/run/bika_service.write.pid" }
    - { regexp: "DUMMY_LOG_FILE_READ", repl: "$HOME/var/log/bika_service.read.log" }
    - { regexp: "DUMMY_LOG_FILE_WRITE", repl: "$HOME/var/log/bika_service.write.log" }
    - { regexp: "DUMMY_HOST", repl: "localhost" }
    - { regexp: "DUMMY_PORT_READ", repl: "8088" }
    - { regexp: "DUMMY_PORT_WRITE", repl: "8086" }
    - { regexp: "DUMMY_SERVER_READ", repl: "paste" }
    - { regexp: "DUMMY_SERVER_WRITE", repl: "wsgiref" }

- name: copy virtualhost config
  become: yes
  template: src=virtualhost.j2 dest=/etc/apache2/sites-available/bika.conf mode=0644

- name: apache2 listen on port 8081
  lineinfile: dest=/etc/apache2/ports.conf regexp="^Listen 80" line="Listen 80\nListen 8081" state=present
  notify:
    - restart apache2

- name: a2ensite {{ DOMAIN }}
  become: yes
  command: a2ensite {{ DOMAIN }}
  args:
    creates: /etc/apache2/sites-enabled/{{ DOMAIN }}.conf
  notify:
    - restart apache2